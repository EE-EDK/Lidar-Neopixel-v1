<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiDAR Controller Evolution: ATtiny vs. RP2040</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?=|cpu|drive|lock|monitor|move|pause|settings|play-button|redo" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D1B2A;
            color: #E0E1DD;
        }
        #simulation-container {
            height: 50vh;
            max-height: 500px;
            min-height: 350px;
            background-color: #070e17;
            cursor: grab;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .kpi-card {
            background-color: #1B263B;
            border-left: 4px solid #F7B801;
        }
        .flow-box {
            background-color: #415A77;
            border: 1px solid #778DA9;
        }
        .flow-arrow {
            color: #F7B801;
        }
        .table-header {
            background-color: #415A77;
        }
        .table-row-dark {
            background-color: #1B263B;
        }
        .table-row-light {
            background-color: #2a344a;
        }
        .roadmap-line {
            width: 4px;
            background-color: #415A77;
            position: relative;
        }
        .roadmap-dot {
            width: 20px;
            height: 20px;
            background-color: #F7B801;
            border: 4px solid #1B263B;
            border-radius: 50%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .roadmap-content {
            border-left: 4px solid #F7B801;
        }
        .icon-box {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background-color: #0D1B2A;
            border-radius: 0.5rem;
            color: #F7B801;
            font-size: 24px;
            flex-shrink: 0;
        }
        .control-button {
            background-color: #1B263B;
            color: #E0E1DD;
            border: 1px solid #415A77;
        }
        .control-button:hover {
            background-color: #415A77;
        }
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: #415A77;
            height: 0.25rem;
            border-radius: 0.25rem;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            margin-top: -6px;
            background-color: #F7B801;
            height: 20px;
            width: 10px;
            border-radius: 3px;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8">

        <section id="simulation" class="mb-20 bg-1B263B rounded-lg shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-415A77">
                <h2 class="text-2xl font-bold text-center text-white">Interactive System Visualization</h2>
                <p class="text-sm text-778DA9 text-center">A simulation of the RP2040 controller detecting an approaching vehicle.</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4">
                <div id="simulation-container" class="md:col-span-3 w-full h-full"></div>
                <div class="p-6 bg-0D1B2A md:bg-transparent flex flex-col justify-between">
                    <div>
                        <h3 class="font-bold text-lg mb-4 text-white">System Status</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-semibold text-778DA9">DISTANCE (cm)</label>
                                <p id="dist-readout" class="text-2xl font-mono font-bold text-white">---</p>
                            </div>
                             <div>
                                <label class="text-xs font-semibold text-778DA9">STRENGTH</label>
                                <p id="strength-readout" class="text-2xl font-mono font-bold text-white">---</p>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-778DA9">VELOCITY (MPH)</label>
                                <p id="velo-readout" class="text-2xl font-mono font-bold text-white">---</p>
                            </div>
                            <div>
                                <label class="text-xs font-semibold text-778DA9">TRIGGER STATUS</label>
                                <p id="status-readout" class="text-2xl font-mono font-bold text-slateGray">INACTIVE</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="font-bold text-lg mb-2 text-white">Parameters</h3>
                         <div class="space-y-4">
                            <div>
                                <label for="speed-slider" class="text-xs font-semibold text-778DA9 flex justify-between">
                                    <span>DRONE SPEED (MPH)</span>
                                    <span id="speed-value" class="font-bold text-white">10 MPH</span>
                                </label>
                                <input type="range" id="speed-slider" min="2" max="45" value="10" step="1" class="w-full">
                            </div>
                            <div>
                                <label for="distance-slider" class="text-xs font-semibold text-778DA9 flex justify-between">
                                    <span>DISTANCE THRESHOLD</span>
                                    <span id="dist-threshold-value" class="font-bold text-white">50 cm</span>
                                </label>
                                <input type="range" id="distance-slider" min="10" max="150" value="50" class="w-full">
                            </div>
                            <div>
                                <label for="velocity-slider" class="text-xs font-semibold text-778DA9 flex justify-between">
                                    <span>VELOCITY THRESHOLD (MPH)</span>
                                    <span id="velo-threshold-value" class="font-bold text-white">-5 MPH</span>
                                </label>
                                <input type="range" id="velocity-slider" min="-45" max="-2" value="-5" step="1" class="w-full">
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="font-bold text-lg mb-4 text-white">Controls</h3>
                        <div class="flex space-x-2">
                            <button id="play-pause-btn" class="control-button p-3 rounded-md flex-grow flex items-center justify-center space-x-2">
                                <i id="play-pause-icon" class="gg-play-button"></i>
                                <span id="play-pause-label">Play</span>
                            </button>
                            <button id="reset-btn" class="control-button p-3 rounded-md flex-grow flex items-center justify-center space-x-2">
                                <i class="gg-redo"></i>
                                <span>Reset</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <header class="text-center mb-16">
            <h1 class="text-4xl md:text-6xl font-black text-white mb-4">A Generational Leap in Capability</h1>
            <p class="text-lg md:text-xl text-778DA9 max-w-4xl mx-auto">From a tactical proof-of-concept to a strategic platform, this is the technical evolution of the LiDAR controller from the constrained ATtiny to the high-performance, dual-core RP2040.</p>
        </header>

        <section id="performance" class="mb-20">
            <h2 class="text-3xl font-bold text-center text-white mb-10">From Bottlenecked to Real-Time</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center mb-12">
                <div class="kpi-card p-8 rounded-lg shadow-2xl text-center md:text-left h-full">
                    <h3 class="text-xl font-bold text-white mb-2">Frame Rate</h3>
                    <p class="text-778DA9 mb-4 text-sm">The dual-core architecture removes processing bottlenecks, enabling a massive leap in data acquisition speed.</p>
                    <div class="text-6xl font-black text-F7B801">~60x</div>
                    <p class="text-lg font-bold text-white mt-2">Increase</p>
                </div>
                 <div class="kpi-card p-8 rounded-lg shadow-2xl text-center md:text-left h-full">
                    <h3 class="text-xl font-bold text-white mb-2">Data Throughput</h3>
                    <p class="text-778DA9 mb-4 text-sm">Higher communication bandwidth ensures the hardware can handle the increased data flow without creating a new bottleneck.</p>
                    <div class="text-6xl font-black text-F7B801">4x</div>
                    <p class="text-lg font-bold text-white mt-2">Higher Bandwidth</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                 <div class="bg-1B263B p-6 rounded-lg shadow-xl lg:col-span-2">
                    <h3 class="text-xl font-bold text-center mb-4">Frame Rate & Bandwidth Comparison</h3>
                    <div class="chart-container h-64 md:h-80"><canvas id="performanceChart"></canvas></div>
                </div>
                 <div class="bg-1B263B p-8 rounded-lg shadow-xl flex flex-col justify-center text-center">
                    <h3 class="text-xl font-bold text-white mb-2">The Critical Enabler</h3>
                    <p class="text-778DA9">A high frame rate is useless if the communication channel can't keep up. The RP2040's superior baud rate is essential to realize the benefits of its processing power, ensuring that the 1000Hz data stream from the LiDAR can be reliably ingested.</p>
                </div>
            </div>
            <div class="bg-1B263B p-6 rounded-lg shadow-xl">
                 <h3 class="text-xl font-bold text-center mb-1">Data Stream Stability: Latency & Jitter</h3>
                 <p class="text-sm text-778DA9 text-center mb-4 max-w-3xl mx-auto">Low, predictable latency (jitter) is critical for high-speed tracking and predictive algorithms. The ATtiny's single-core design introduces massive jitter under load, while the RP2040's dedicated cores ensure a stable data stream.</p>
                <div class="chart-container h-80"><canvas id="latencyChart"></canvas></div>
            </div>
        </section>
        
        <section id="integrity" class="mb-20">
            <h2 class="text-3xl font-bold text-center text-white mb-10">From Fragile to Failsafe: System Integrity & Tooling</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
                <div class="bg-1B263B p-8 rounded-lg shadow-xl h-full">
                    <h3 class="text-xl font-bold mb-6 text-center">ATtiny: Fragile Foundations</h3>
                    <ul class="space-y-6">
                        <li class="flex items-start space-x-4">
                            <div class="icon-box">💾</div>
                            <div>
                                <h4 class="font-bold text-white">EEPROM Storage</h4>
                                <p class="text-sm text-778DA9">Single-byte settings stored directly in memory. Limited complexity, no versioning, and susceptible to wear over time.</p>
                            </div>
                        </li>
                        <li class="flex items-start space-x-4">
                            <div class="icon-box">⏸️</div>
                            <div>
                                <h4 class="font-bold text-white">Interrupt Halting</h4>
                                <p class="text-sm text-778DA9">Processor must freeze all operations (a "stop-the-world" event) to ensure data is read safely, a crude method that introduces latency.</p>
                            </div>
                        </li>
                        <li class="flex items-start space-x-4">
                           <div class="icon-box">⚙️</div>
                            <div>
                                <h4 class="font-bold text-white">Physical Configuration</h4>
                                <p class="text-sm text-778DA9">Relies on manual, time-sensitive switch sequences at boot to change core operating modes. Impractical for fielded units.</p>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="bg-1B263B p-8 rounded-lg shadow-xl h-full">
                    <h3 class="text-xl font-bold mb-6 text-center">RP2040: Failsafe by Design</h3>
                     <ul class="space-y-6">
                        <li class="flex items-start space-x-4">
                            <div class="icon-box">📁</div>
                            <div>
                                <h4 class="font-bold text-white">LittleFS File System</h4>
                                <p class="text-sm text-778DA9">Robust, versionable configuration files stored on flash, enabling complex settings and easy updates, just like a computer.</p>
                            </div>
                        </li>
                        <li class="flex items-start space-x-4">
                            <div class="icon-box">🔒</div>
                            <div>
                                <h4 class="font-bold text-white">Mutex Locks</h4>
                                <p class="text-sm text-778DA9">Surgical data protection. Allows cores to share information safely without halting unrelated, high-priority tasks like data acquisition.</p>
                            </div>
                        </li>
                        <li class="flex items-start space-x-4">
                           <div class="icon-box">🖥️</div>
                            <div>
                                <h4 class="font-bold text-white">Professional GUI Protocol</h4>
                                <p class="text-sm text-778DA9">A dedicated, packet-based communication protocol for advanced configuration, diagnostics, and real-time monitoring.</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="architecture" class="mb-20">
            <h2 class="text-3xl font-bold text-center text-white mb-10">The Architecture Revolution</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
                <div class="bg-1B263B p-8 rounded-lg shadow-xl h-full">
                    <h3 class="text-xl font-bold mb-6 text-center">ATtiny: The Single-Core Bottleneck</h3>
                    <div class="flex flex-col items-center space-y-4">
                        <div class="flow-box p-4 rounded-lg w-full text-center">Data Acquisition (HardwareSerial)</div>
                        <div class="text-2xl font-bold flow-arrow">&darr;</div>
                        <div class="flow-box p-4 rounded-lg w-full text-center">Sequential Processing & Calculation</div>
                        <div class="text-2xl font-bold flow-arrow">&darr;</div>
                        <div class="flow-box p-4 rounded-lg w-full text-center">Handle Inputs & Debug (Blocking)</div>
                        <p class="text-sm text-778DA9 italic text-center pt-4">All tasks run sequentially in a single loop. Enabling debug output via SoftwareSerial can halt data acquisition, crashing the effective frame rate from 16Hz to less than 1Hz.</p>
                    </div>
                </div>
                <div class="bg-1B263B p-8 rounded-lg shadow-xl h-full">
                    <h3 class="text-xl font-bold mb-6 text-center">RP2040: Dual-Core Specialization</h3>
                    <div class="flex justify-around items-start">
                        <div class="flex flex-col items-center space-y-4 w-1/2 px-2">
                            <h4 class="font-semibold text-F7B801">Core 0 (Acquisition)</h4>
                            <div class="flow-box p-4 rounded-lg w-full text-center h-full flex items-center justify-center">Uninterrupted High-Frequency Data Acquisition via UART</div>
                        </div>
                        <div class="flex flex-col items-center space-y-4 w-1/2 px-2">
                            <h4 class="font-semibold text-F7B801">Core 1 (Processing)</h4>
                            <div class="flow-box p-4 rounded-lg w-full text-center">Advanced Data Processing (Mutex-Protected Buffer)</div>
                            <div class="text-2xl font-bold flow-arrow">&darr;</div>
                            <div class="flow-box p-4 rounded-lg w-full text-center">Trigger Logic & GUI Comms</div>
                        </div>
                    </div>
                     <p class="text-sm text-778DA9 italic text-center pt-8">Dedicated cores work in parallel. Data collection is never blocked by processing or other tasks, ensuring maximum performance and stability.</p>
                </div>
            </div>
        </section>
        
        <section id="logic-evolution" class="mb-20">
            <h2 class="text-3xl font-bold text-center text-white mb-10">From Simple Triggering to Context-Aware Logic</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
                <div class="bg-1B263B p-8 rounded-lg shadow-xl h-full">
                    <h3 class="text-xl font-bold mb-6 text-center">ATtiny: Simple, One-Dimensional Triggering</h3>
                    <p class="text-sm text-778DA9 text-center mb-8">The logic is direct and binary. It can only answer one question: "Is an object within the set distance?" This is vulnerable to false positives from sensor noise or ambiguous readings.</p>
                    <div class="flex flex-col items-center space-y-4">
                        <div class="flow-box p-4 rounded-lg w-4/5 text-center">Raw Distance Reading</div>
                        <div class="text-2xl font-bold flow-arrow">&darr;</div>
                        <div class="flow-box p-4 rounded-lg w-4/5 text-center font-mono">Is distance &lt; threshold?</div>
                        <div class="text-2xl font-bold flow-arrow">&darr;</div>
                        <div class="flow-box p-4 rounded-lg w-4/5 text-center font-bold text-F7B801 border-F7B801">TRIGGER</div>
                    </div>
                </div>
                <div class="bg-1B263B p-8 rounded-lg shadow-xl h-full">
                    <h3 class="text-xl font-bold mb-6 text-center">RP2040: Multi-Factor, Contextual Logic</h3>
                    <p class="text-sm text-778DA9 text-center mb-8">The RP2040 can analyze multiple variables from the LiDAR frame simultaneously. It can be programmed to ignore a valid distance reading if other factors suggest it's unreliable.</p>
                    <div class="flex flex-col items-center">
                        <div class="grid grid-cols-2 gap-4 w-full mb-4">
                            <div class="flow-box p-3 rounded-md text-sm text-center">Distance</div>
                            <div class="flow-box p-3 rounded-md text-sm text-center">Velocity</div>
                            <div class="flow-box p-3 rounded-md text-sm text-center">Signal Strength</div>
                            <div class="flow-box p-3 rounded-md text-sm text-center">Temperature</div>
                        </div>
                        <div class="text-2xl font-bold flow-arrow">&darr;</div>
                        <div class="flow-box p-4 rounded-lg w-4/5 text-center my-4">
                            <h4 class="font-bold">Logic Core</h4>
                            <p class="text-xs font-mono text-778DA9">e.g., IF dist&lt;thresh AND velocity&gt;min AND strength&gt;200</p>
                        </div>
                        <div class="text-2xl font-bold flow-arrow">&darr;</div>
                        <div class="flow-box p-4 rounded-lg w-4/5 text-center font-bold text-F7B801 border-F7B801">SMART TRIGGER</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="future-potential" class="mb-20">
            <h2 class="text-3xl font-bold text-center text-white mb-10">RP2040: A Strategic Platform for the Future</h2>
            <div class="bg-1B263B p-8 rounded-lg shadow-xl">
                <div class="relative pl-8">
                    <div class="roadmap-line absolute left-0 top-0 bottom-0"></div>
                    <div class="mb-8">
                        <div class="roadmap-dot top-0"></div>
                        <div class="roadmap-content ml-8 pl-6 pb-4 rounded-r-lg">
                            <h4 class="text-lg font-bold text-white">Machine Learning on the Edge</h4>
                            <p class="text-sm text-778DA9">Utilize TinyML frameworks to perform on-device object classification (e.g., person vs. vehicle), moving beyond simple presence detection.</p>
                        </div>
                    </div>
                    <div class="mb-8">
                        <div class="roadmap-dot top-0"></div>
                        <div class="roadmap-content ml-8 pl-6 pb-4 rounded-r-lg">
                            <h4 class="text-lg font-bold text-white">Multi-Sensor Fusion</h4>
                            <p class="text-sm text-778DA9">Integrate data from other sensors like IMUs or thermal cameras for enhanced environmental understanding and more robust tracking.</p>
                        </div>
                    </div>
                    <div>
                        <div class="roadmap-dot top-0"></div>
                        <div class="roadmap-content ml-8 pl-6 pb-4 rounded-r-lg">
                            <h4 class="text-lg font-bold text-white">Programmable I/O (PIO) for Custom Interfaces</h4>
                            <p class="text-sm text-778DA9">Leverage the RP2040's unique PIO to create hardware-level support for any communication protocol (e.g., CAN bus, DMX), offloading the work from the main CPUs for perfect timing.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="summary-table" class="mb-16">
            <h2 class="text-3xl font-bold text-center text-white mb-10">Detailed Comparison Matrix</h2>
            <div class="overflow-x-auto bg-1B263B rounded-lg shadow-xl">
                <table class="w-full text-left text-sm md:text-base">
                    <thead class="table-header text-white">
                        <tr>
                            <th class="p-4">Feature</th>
                            <th class="p-4">ATtiny-1634 (Legacy)</th>
                            <th class="p-4 text-F7B801">RP2040 (Professional Upgrade)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-row-dark border-t border-gray-700">
                            <td class="p-4 font-semibold">Core Architecture</td><td class="p-4">Single-Core MCU</td><td class="p-4 font-medium">Dual-Core MCU</td>
                        </tr>
                        <tr class="table-row-light border-t border-gray-700">
                            <td class="p-4 font-semibold">Data Throughput</td><td class="p-4">115,200 baud</td><td class="p-4 font-medium">460,800 baud</td>
                        </tr>
                         <tr class="table-row-dark border-t border-gray-700">
                            <td class="p-4 font-semibold">Concurrency Control</td><td class="p-4">Interrupt Halting</td><td class="p-4 font-medium">Mutex Locks</td>
                        </tr>
                         <tr class="table-row-light border-t border-gray-700">
                            <td class="p-4 font-semibold">Configuration Storage</td><td class="p-4">EEPROM</td><td class="p-4 font-medium">LittleFS File System</td>
                        </tr>
                        <tr class="table-row-dark border-t border-gray-700">
                            <td class="p-4 font-semibold">Algorithm Complexity</td><td class="p-4">Simple Filtering (3-sample)</td><td class="p-4 font-medium">Adaptive Median Filtering (15-sample)</td>
                        </tr>
                        <tr class="table-row-light border-t border-gray-700">
                            <td class="p-4 font-semibold">Error Recovery</td><td class="p-4">Full Re-initialization</td><td class="p-4 font-medium">Graduated Recovery System</td>
                        </tr>
                         <tr class="table-row-dark border-t border-gray-700">
                            <td class="p-4 font-semibold">Future Upgrade Path</td><td class="p-4">None (Hardware limited)</td><td class="p-4 font-medium">Extensive (ML, PIO, Sensor Fusion)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        const vibrantPalette = {
            darkBlue: '#0D1B2A', gunmetal: '#1B263B', shadowBlue: '#415A77',
            slateGray: '#778DA9', platinum: '#E0E1DD', accentYellow: '#F7B801'
        };
        const CMPS_TO_MPH = 0.0223694;
        const MPH_TO_CMPS = 1 / CMPS_TO_MPH;

        const chartTooltipConfig = {
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) { return label.join(' '); }
                            return label;
                        }
                    }
                },
                legend: { labels: { color: vibrantPalette.platinum } }
            },
            scales: {
                y: { ticks: { color: vibrantPalette.slateGray, beginAtZero: true }, grid: { color: 'rgba(119, 141, 169, 0.2)' } },
                x: { ticks: { color: vibrantPalette.slateGray }, grid: { color: 'rgba(119, 141, 169, 0.1)' } }
            },
            maintainAspectRatio: false
        };
        
        const simulationContainer = document.getElementById('simulation-container');
        const distReadout = document.getElementById('dist-readout');
        const strengthReadout = document.getElementById('strength-readout');
        const veloReadout = document.getElementById('velo-readout');
        const statusReadout = document.getElementById('status-readout');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const playPauseLabel = document.getElementById('play-pause-label');
        const resetBtn = document.getElementById('reset-btn');
        const distanceSlider = document.getElementById('distance-slider');
        const velocitySlider = document.getElementById('velocity-slider');
        const speedSlider = document.getElementById('speed-slider');
        const distThresholdValue = document.getElementById('dist-threshold-value');
        const veloThresholdValue = document.getElementById('velo-threshold-value');
        const speedValue = document.getElementById('speed-value');

        let scene, camera, renderer, drone, vehicle, triggerZone, lidarBeam;
        let particles = [];
        let isPlaying = false;
        let lastTime = 0;
        let droneSpeed = 10 * MPH_TO_CMPS; 
        const VISUAL_SPEED_FACTOR = 0.1;
        const vehiclePosition = new THREE.Vector3(100, 0, -100);
        const droneStartPosition = new THREE.Vector3(-150, 20, 200);
        const droneDirection = new THREE.Vector3().subVectors(vehiclePosition, droneStartPosition).normalize();

        let distanceThreshold = 50;
        let velocityThreshold = -5 * MPH_TO_CMPS;
        const strengthThreshold = 200;

        function initSimulation() {
            scene = new THREE.Scene();
            const aspectRatio = simulationContainer.clientWidth / simulationContainer.clientHeight;
            const viewSize = 500;
            camera = new THREE.OrthographicCamera(-aspectRatio * viewSize / 2, aspectRatio * viewSize / 2, viewSize / 2, -viewSize / 2, 1, 1000);
            camera.position.set(50, 150, 50);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(simulationContainer.clientWidth, simulationContainer.clientHeight);
            renderer.setClearColor(0x070e17);
            simulationContainer.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(50, 100, 25);
            scene.add(directionalLight);

            const gridHelper = new THREE.GridHelper(500, 25, 0x1B263B, 0x1B263B);
            scene.add(gridHelper);

            const droneBody = new THREE.Mesh(new THREE.CylinderGeometry(12, 12, 6, 8), new THREE.MeshLambertMaterial({ color: vibrantPalette.platinum }));
            droneBody.rotation.y = Math.PI / 8;
            const droneArm = new THREE.BoxGeometry(3, 2, 40);
            const armMaterial = new THREE.MeshLambertMaterial({ color: vibrantPalette.slateGray });
            const droneArm1 = new THREE.Mesh(droneArm, armMaterial);
            droneArm1.rotation.y = Math.PI / 4;
            const droneArm2 = new THREE.Mesh(droneArm, armMaterial);
            droneArm2.rotation.y = -Math.PI / 4;
            const propGeom = new THREE.CylinderGeometry(5, 5, 1, 6);
            const propMaterial = new THREE.MeshLambertMaterial({ color: vibrantPalette.shadowBlue });
            const prop1 = new THREE.Mesh(propGeom, propMaterial); prop1.position.set(14, 2, 14);
            const prop2 = new THREE.Mesh(propGeom, propMaterial); prop2.position.set(-14, 2, 14);
            const prop3 = new THREE.Mesh(propGeom, propMaterial); prop3.position.set(14, 2, -14);
            const prop4 = new THREE.Mesh(propGeom, propMaterial); prop4.position.set(-14, 2, -14);
            drone = new THREE.Group();
            drone.add(droneBody, droneArm1, droneArm2, prop1, prop2, prop3, prop4);
            scene.add(drone);
            
            const chassis = new THREE.Mesh(new THREE.BoxGeometry(30, 10, 60), new THREE.MeshLambertMaterial({ color: vibrantPalette.shadowBlue }));
            chassis.position.y = 10;
            const cabin = new THREE.Mesh(new THREE.BoxGeometry(28, 10, 30), new THREE.MeshLambertMaterial({ color: vibrantPalette.slateGray }));
            cabin.position.y = 20; cabin.position.z = -5;
            const wheelGeom = new THREE.CylinderGeometry(6, 6, 4, 12);
            const wheelMat = new THREE.MeshLambertMaterial({ color: '#333333' });
            const wheel1 = new THREE.Mesh(wheelGeom, wheelMat); wheel1.rotation.z = Math.PI / 2; wheel1.position.set(17, 6, 20);
            const wheel2 = new THREE.Mesh(wheelGeom, wheelMat); wheel2.rotation.z = Math.PI / 2; wheel2.position.set(-17, 6, 20);
            const wheel3 = new THREE.Mesh(wheelGeom, wheelMat); wheel3.rotation.z = Math.PI / 2; wheel3.position.set(17, 6, -20);
            const wheel4 = new THREE.Mesh(wheelGeom, wheelMat); wheel4.rotation.z = Math.PI / 2; wheel4.position.set(-17, 6, -20);
            vehicle = new THREE.Group();
            vehicle.add(chassis, cabin, wheel1, wheel2, wheel3, wheel4);
            vehicle.position.copy(vehiclePosition);
            scene.add(vehicle);
            
            const triggerGeom = new THREE.CircleGeometry(1, 32);
            triggerZone = new THREE.Mesh(triggerGeom, new THREE.MeshBasicMaterial({ color: vibrantPalette.accentYellow, transparent: true, opacity: 0.1, side: THREE.DoubleSide }));
            triggerZone.rotation.x = -Math.PI / 2;
            triggerZone.position.copy(vehicle.position);
            triggerZone.position.y = 0.1;
            scene.add(triggerZone);

            lidarBeam = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 2, 1, 8), new THREE.MeshBasicMaterial({ color: vibrantPalette.accentYellow, transparent: true }));
            lidarBeam.visible = false;
            scene.add(lidarBeam);

            window.addEventListener('resize', onWindowResize, false);
            playPauseBtn.addEventListener('click', togglePlay);
            resetBtn.addEventListener('click', resetSimulation);

            speedSlider.addEventListener('input', (e) => {
                const mph = parseFloat(e.target.value);
                speedValue.textContent = `${mph} MPH`;
                droneSpeed = mph * MPH_TO_CMPS;
            });
            distanceSlider.addEventListener('input', (e) => {
                distanceThreshold = parseFloat(e.target.value);
                distThresholdValue.textContent = `${distanceThreshold} cm`;
                triggerZone.scale.set(distanceThreshold, distanceThreshold, 1);
            });
            velocitySlider.addEventListener('input', (e) => {
                const mph = parseFloat(e.target.value);
                veloThresholdValue.textContent = `${mph} MPH`;
                velocityThreshold = mph * MPH_TO_CMPS;
            });

            resetSimulation();
            animate();
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            updatePlayButton();
        }
        
        function updatePlayButton() {
            playPauseIcon.className = isPlaying ? 'gg-pause' : 'gg-play-button';
            playPauseLabel.textContent = isPlaying ? 'Pause' : 'Play';
        }

        function resetSimulation() {
            isPlaying = false;
            updatePlayButton();
            drone.position.copy(droneStartPosition);
            drone.visible = true;
            lastTime = 0;
            distReadout.textContent = '---';
            strengthReadout.textContent = '---';
            veloReadout.textContent = '---';
            statusReadout.textContent = 'INACTIVE';
            statusReadout.style.color = vibrantPalette.slateGray;
            triggerZone.material.color.set(vibrantPalette.accentYellow);
            triggerZone.material.opacity = 0.1;
            triggerZone.scale.set(distanceThreshold, distanceThreshold, 1);

            particles.forEach(p => scene.remove(p));
            particles = [];
        }

        function createExplosion(position) {
            const particleCount = 100;
            const particleMaterial = new THREE.MeshBasicMaterial({ color: vibrantPalette.accentYellow, transparent: true });

            for (let i = 0; i < particleCount; i++) {
                const particle = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), particleMaterial.clone());
                particle.position.copy(position);
                
                particle.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 50,
                    (Math.random() - 0.5) * 50
                );
                particle.lifespan = 1 + Math.random();
                
                particles.push(particle);
                scene.add(particle);
            }
        }

        function onWindowResize() {
            const aspectRatio = simulationContainer.clientWidth / simulationContainer.clientHeight;
            const viewSize = 500;
            camera.left = -aspectRatio * viewSize / 2;
            camera.right = aspectRatio * viewSize / 2;
            camera.top = viewSize / 2;
            camera.bottom = -viewSize / 2;
            camera.updateProjectionMatrix();
            renderer.setSize(simulationContainer.clientWidth, simulationContainer.clientHeight);
        }

        function animate(time) {
            requestAnimationFrame(animate);
            const now = time * 0.001;
            const deltaTime = lastTime > 0 ? now - lastTime : 0;
            lastTime = now;

            if (isPlaying) {
                drone.position.addScaledVector(droneDirection, droneSpeed * VISUAL_SPEED_FACTOR * deltaTime);
                if (drone.position.distanceTo(vehicle.position) < 10) {
                    drone.position.copy(droneStartPosition);
                }
            }
            if (drone.visible) {
                 drone.lookAt(vehicle.position);
            }

            const distance = Math.max(0, drone.position.distanceTo(vehicle.position) - 30);
            distReadout.textContent = distance.toFixed(1);
            
            const currentVelocityCmps = (isPlaying && drone.visible) ? -droneSpeed : 0;
            veloReadout.textContent = (currentVelocityCmps * CMPS_TO_MPH).toFixed(1);

            let strength = 0;
            if (distance < 400) {
                strength = Math.max(0, 600 - distance * 1.5);
            }
            strengthReadout.textContent = strength.toFixed(0);

            if (distance < 999 && drone.visible) {
                lidarBeam.visible = true;
                const beamStart = drone.position.clone();
                const beamEnd = vehicle.position.clone();
                const beamVector = new THREE.Vector3().subVectors(beamEnd, beamStart);
                lidarBeam.position.copy(beamStart).addScaledVector(beamVector, 0.5);
                lidarBeam.scale.y = beamVector.length();
                lidarBeam.lookAt(beamEnd);
                lidarBeam.material.opacity = Math.min(0.9, strength / 500);
            } else {
                lidarBeam.visible = false;
            }

            if (drone.visible && distance < distanceThreshold && currentVelocityCmps < velocityThreshold && strength > strengthThreshold) {
                statusReadout.textContent = 'ACTIVE';
                statusReadout.style.color = vibrantPalette.accentYellow;
                triggerZone.material.color.set(0xff0000);
                triggerZone.material.opacity = 0.3;
                createExplosion(drone.position);
                drone.visible = false;
                isPlaying = false;
                updatePlayButton();
            } else if (drone.visible) {
                statusReadout.textContent = 'INACTIVE';
                statusReadout.style.color = vibrantPalette.slateGray;
                triggerZone.material.color.set(vibrantPalette.accentYellow);
                triggerZone.material.opacity = 0.1;
            }

            particles.forEach((p, index) => {
                p.position.addScaledVector(p.velocity, deltaTime);
                p.velocity.y -= 9.8 * deltaTime * 2; 
                p.lifespan -= deltaTime;
                p.material.opacity = p.lifespan;
                if (p.lifespan <= 0) {
                    scene.remove(p);
                    particles.splice(index, 1);
                }
            });

            renderer.render(scene, camera);
        }
        
        initSimulation();

        new Chart(document.getElementById('performanceChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['ATtiny', 'RP2040'],
                datasets: [{
                    label: 'Frames per Second', data: [16, 1000],
                    backgroundColor: vibrantPalette.accentYellow,
                    borderColor: '#F7B801', borderWidth: 1, categoryPercentage: 0.6
                }, {
                    label: 'Baud Rate (kbps)', data: [115.2, 460.8],
                    backgroundColor: vibrantPalette.shadowBlue,
                    borderColor: vibrantPalette.slateGray, borderWidth: 1, categoryPercentage: 0.6
                }]
            },
            options: { ...chartTooltipConfig, indexAxis: 'y', scales: { ...chartTooltipConfig.scales, x: {...chartTooltipConfig.scales.x, type: 'logarithmic'}} }
        });

        new Chart(document.getElementById('latencyChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: ['0s', '1s', '2s (Debug On)', '3s', '4s', '5s'],
                datasets: [{
                    label: 'ATtiny Latency (ms)', data: [61, 63, 650, 645, 62, 61],
                    borderColor: vibrantPalette.slateGray, tension: 0.1, fill: false
                }, {
                    label: 'RP2040 Latency (ms)', data: [1, 1, 1, 1, 1, 1],
                    borderColor: vibrantPalette.accentYellow, backgroundColor: 'rgba(247, 184, 1, 0.2)', tension: 0.1, fill: true
                }]
            },
            options: { ...chartTooltipConfig, scales: { ...chartTooltipConfig.scales, y: {...chartTooltipConfig.scales.y, title: {display: true, text: 'Time Between Frames (ms)', color: vibrantPalette.platinum}}}}
        });
        
    </script>
</body>
</html>


